SNR = (5, 10, 20, 30)
REPLICATE = range(1,6)
NUMBER = range(1,25)


rule all:
    input:
        expand("data/mrxcat_simulations/snr{snr}_{replicate}/nifti/cine_1x1x1mm_512x512x1x24x4_snr{snr}_fa90_bh{number}.nii.gz", 
        snr=SNR, replicate=REPLICATE, number=NUMBER),
        expand("data/mrxcat_simulations/mask_data/nifti_myc_cleared/{masks}.nii.gz", masks=NUMBER)

rule SimSaveAsCsv:
    input:
        "data/mrxcat_simulations"
    output:
        expand("data/mrxcat_simulations/snr{snr}_{replicate}/csvs/cine_1x1x1mm_512x512x1x24x4_snr{snr}_fa90_bh{number}.csv",
               snr=SNR, replicate=REPLICATE, number=NUMBER)
    conda:
        "octave_env.yaml"
    shell:
        "cd code/mrxcat_simulations;"
        "octave SaveAsCsv.m --no-gui"

rule SimConvertCsvToNifti:
    input:
        "data/mrxcat_simulations/snr{snr}_{replicate}/csvs/cine_1x1x1mm_512x512x1x24x4_snr{snr}_fa90_bh{number}.csv"
    output:
        "data/mrxcat_simulations/snr{snr}_{replicate}/nifti/cine_1x1x1mm_512x512x1x24x4_snr{snr}_fa90_bh{number}.nii.gz"
    conda:
        "conversion_sim.yaml"
    script:
        "../code/mrxcat_simulations/convert_csv_to_nifti.py"

rule SimConvertMaskBinToNifti:
    input:
        "data/mrxcat_simulations/mask_data/bin_files/cine_act_{masks}.bin"
    output:
        "data/mrxcat_simulations/mask_data/nifti_after_conv/cine_act_{masks}.nii.gz"
    conda:
        "conversion_sim.yaml"
    script:
        "../code/mrxcat_simulations/bin_convert.py"

rule SimMaskConvToMyc:
    input:
        "data/mrxcat_simulations/mask_data/nifti_after_conv/cine_act_{masks}.nii.gz"
    output:
        "data/mrxcat_simulations/mask_data/nifti_myc/cine_act_{masks}.nii.gz"
    conda:
        "conversion_sim.yaml"
    script:
        "../code/mrxcat_simulations/conv_msk_to_myc.py"

rule UnpackNifti:
    input:
        "data/mrxcat_simulations/mask_data/nifti_myc/cine_act_{masks}.nii.gz"
    output:
        "data/mrxcat_simulations/mask_data/nifti_myc/cine_act_{masks}.nii"
    shell:
        "gzip -d {input}"

rule RemovePapillaryMusclesFromMask:
    input:
        "data/mrxcat_simulations/mask_data/nifti_myc/cine_act_{masks}.nii",
        "data/mrxcat_simulations/mask_data/nifti_myc_cleared/{masks}.xdelta"
    output:
        "data/mrxcat_simulations/mask_data/nifti_myc_cleared/{masks}.nii"
    script:
        "xpatcher.sh"

rule RepackNifti:
    input:
        "data/mrxcat_simulations/mask_data/nifti_myc_cleared/{masks}.nii"
    output:
        "data/mrxcat_simulations/mask_data/nifti_myc_cleared/{masks}.nii.gz"
    shell:
        "gzip {input}"